AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  ConnectionArn: { Type: String }
  FullRepositoryId: { Type: String, Description: "Ex: usuario/repositorio" }
  S3BucketName: { Type: String }
  CloudFrontDistId: { Type: String }

Resources:
  # CodeBuild: O operario que roda o comando de sincronizacao
  MyBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Artifacts: { Type: CODEPIPELINE }
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
        EnvironmentVariables:
          - { Name: BUCKET_NAME, Value: !Ref S3BucketName }
          - { Name: DIST_ID, Value: !Ref CloudFrontDistId }
      Source: { Type: CODEPIPELINE }

  # CodePipeline: O gerente que vigia o GitHub
  MyPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn: !GetAtt PipelineRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref S3BucketName
      Stages:
        - Name: Source
          Actions:
            - Name: GitHub
              ActionTypeId: { Category: Source, Owner: AWS, Provider: CodeStarSourceConnection, Version: "1" }
              Configuration:
                ConnectionArn: !Ref ConnectionArn
                FullRepositoryId: !Ref FullRepositoryId
                BranchName: main
              OutputArtifacts: [ { Name: SourceOutput } ]
        - Name: Deploy
          Actions:
            - Name: BuildAndDeploy
              ActionTypeId: { Category: Build, Owner: AWS, Provider: CodeBuild, Version: "1" }
              InputArtifacts: [ { Name: SourceOutput } ]
              Configuration: { ProjectName: !Ref MyBuildProject }

  # Permissoes/Roles (IAM)
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement: [ { Effect: Allow, Principal: { Service: codebuild.amazonaws.com }, Action: "sts:AssumeRole" } ]
      Policies:
        - PolicyName: CodeBuildAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                  - "s3:PutObject"
                  - "s3:GetObject"
                  - "s3:DeleteObject"
                  - "s3:ListBucket"
                  - "cloudfront:CreateInvalidation"
                Resource: "*"
  PipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement: [ { Effect: Allow, Principal: { Service: codepipeline.amazonaws.com }, Action: "sts:AssumeRole" } ]
      Policies:
        - PolicyName: PipelineAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: [ "codestar-connections:UseConnection", "codebuild:StartBuild", "codebuild:BatchGetBuilds", "s3:*" ]
                Resource: "*"
              
